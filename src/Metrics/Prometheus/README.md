# gems.metrics.prometheus

Это библиотека .NET является реализацией интерфейсов и абстрактных классов библиотеки Gems.Metrics.Abstractions. Данная библиотека предоставляет экспорт метрик в [Prometheus](http://prometheus.io/). Библиотека использует библиотеку [prometheus-net](https://github.com/prometheus-net/prometheus-net), которая предоставляет API для взаимодействия с Prometheus.

Библиотека предназначена для следующих сред выполнения (и новее):

* .NET 6.0

# Содержание

* [Установка и настройка](#установка-и-настройка)
* [Использование метрик](#использование-метрик)
* [Сброс метрик](#сброс-метрик)

# Установка

- Установите nuget пакет **Gems.Metrics** через менеджер пакетов.
- Установите nuget пакет **Gems.Metrics.Prometheus** через менеджер пакетов.
- Установите nuget пакет **prometheus-net.AspNetCore** через менеджер пакетов.
- Подключите реализацию интерфейса IMetricsService с помощью DI:
```csharp
services.AddPrometheus(this.Configuration);;
```
- После строки **app.UseRouting();** добавьте следующие строки:
```csharp
app.UseHttpMetrics();
app.UseEndpoints(endpoints =>
{
	endpoints.MapMetrics();
});
```
- В appsettings.json пропишите настройки:
```json
"PrometheusMetrics": {
	"Configuration": {
	  "HistogramConfiguration": {
		"your_histogram_metric_name": {
		    "Buckets": [ 1, 5, 10, 15, 30, 60, 120, 240, 360, 480, 600, 720, 840, 960, 1080, 1200, 1320, 1440, 1560, 1680, 1800, 1920 ] // Шкала гистограммы. Необходимо указать свои значения.
		    "StaticLabels" : { }, // Статические метки, применяемые ко всем экземплярам этой метрики. Эти метки не могут быть впоследствии перезаписаны.
		    "SuppressInitialValue": false, // Если значение true, то метрика не будет опубликована до тех пор, пока ее значение не будет изменено
		    "LabelNames": [] // Имена всех полей меток, определенных для каждого экземпляра метрики. Если значение равно null, метрика будет создана без каких-либо меток для конкретного экземпляра.
	      }
	  },
	  "CounterConfiguration": {
		"your_counter_metric_name": {
		    "StaticLabels" : { }, // Статические метки, применяемые ко всем экземплярам этой метрики. Эти метки не могут быть впоследствии перезаписаны.
		    "SuppressInitialValue": false, // Если значение true, то метрика не будет опубликована до тех пор, пока ее значение не будет изменено
		    "LabelNames": [] // Имена всех полей меток, определенных для каждого экземпляра метрики. Если значение равно null, метрика будет создана без каких-либо меток для конкретного экземпляра.
	      }
	  },
      
	  "GaugeConfiguration": {
		"your_gauge_metric_name": {
		    "StaticLabels" : { }, // Статические метки, применяемые ко всем экземплярам этой метрики. Эти метки не могут быть впоследствии перезаписаны.
		    "SuppressInitialValue": false, // Если значение true, то метрика не будет опубликована до тех пор, пока ее значение не будет изменено
		    "LabelNames": [] // Имена всех полей меток, определенных для каждого экземпляра метрики. Если значение равно null, метрика будет создана без каких-либо меток для конкретного экземпляра.
	      }
	  }
	}
}
```
# Использование метрик
Как использовать метрики: счетчик (Counter), измеритель (Gauge), гистограмму (Histogram), таймер (TimeMetric) смотрите в описании библиотеки [Gems.Metrics](/src/Metrics/Metrics/README.md))  
Многие метрики пишутся по умолчанию при работе с данными посредством библиотеки Gems.Data (см. [здесь](/src/Metrics/Data/README.md)), исходящими запросами посредством библиотеки Gems.Http (см. [здесь](/src/Metrics/Http/README.md)) 
или при подключении пайплайнов для Mediatr (см. [здесь](/src/Metrics/Metrics/README.md#использование-пайплайнов)).  

# Сброс метрик
Метрики можно настроить так, чтобы они сбрасывались через определенное время. 
Для этого необходимо подключить соответсвующий пайплайн для Mediatr (см. [здесь](/src/Metrics/Metrics/README.md#resetmetricsbehavior)).
# Gems.FeatureToggle

Gems.FeatureToggle Позволяет динамически управлять набором выключателей функций, налету включать и отключать функции, постепенно делать доступным функционал для части пользователей на основе какого-либо критерия. 

## Когда использовать FeatureToggle

Выключатели FeatureToggle удобно использовать:
- когда необходимо оперативно включать/выключать некоторую функциональность сервиса. Например включать расширенное логирование в определенные моменты и выключать когда в нем нет необходимости;
- в случае добавления новой функциональности, что бы иметь возможность оперативно отключить ее при неполадках;
- для включения функциональности в определенный момент, независимо от релиза; 
- в случаях когда функцию нужно сделать доступной для части пользователей и оперативно управлять % пользователей;
- когда необходимо провести сравнительный анализ, A/B тестирование. 

Важно не допускать большого количества временных выключателей и своевременно удалять неактуальные.

## Как лучше использовать FeatureToggle

- Один выключатель - одно использование. Минимизируйте и группируйте логику на которую влияет один выключатель. При изменении состояния будет проще понять все взаимовлияния и возможные варианты поведения;
- В состоянии по умолчанию должен работать надежный и проверенный код. Значение выключателя False и None будут возвращать приложение в рабочее состояние;
- Активируйте по шагам, анализируя результат. Выкатывайте функциональность постепенно, управляя окружением dev/stage/prod, группой пользователей или долей проникновения фичи;
- Используйте интуитивно-понятные названия. При чтении названия должно быть ясно поведение программы при всех состояниях;
- Удаляйте неактуальные выключатели. Хорошие кандидаты: флаги которые пережили несколько релизов, выключатели которые не используются, выключатели с высоким процентом выкатки.

## Установка

### Установка пакета

Добавьте пакет <CODE>Gems.FeatureToggle</CODE> в проект.


### Добавьте необходимые настройки в конфигурационный файл

Для того чтобы начать использовать FeatureToggle необходимо на странице проекта Gitlab выбрать секцию <CODE><B>Deployments => Feature Flags</B></CODE>. На появившейся странице нажать <CODE><B>Configure</B></CODE> и скопировать значения 
<CODE><B>API Url</B></CODE> и <CODE><B>InstanceID</B></CODE> в конфигурационный файл <CODE>application.*.json</CODE>. Кроме того, для каждого варианта развертывания приложения (<CODE><B>dev/stage/prod</B></CODE>) нужно указать соответствующее значение <CODE><B>Environment</B></CODE>.

```json
{
    "FeatureToggle" :
    {
        "Environment": "[dev/stage/prod]",
        "Token": "[InstanceID]",
        "Url": "[API Url]"
    }
}
```
### Дополнительные настройки

- <CODE><B>FetchTogglesInterval</B></CODE> позволяет указать период опроса с которым происходит проверка наличия изменений. Значение по умолчанию: <CODE>"FetchTogglesInterval": "00:00:30"</CODE> (30 секунд).
- <CODE><B>SynchronousInitialization</B></CODE> В синхронном режиме состояние с сервера запрашивается во время запуска. При ошибке запуск будет прерван. В асинхронном режиме до получения первых данных будут использованы настройки по умолчанию. Значение по умолчанию: <CODE>true</CODE>
- <CODE><B>EnableBootstrapLoading</B></CODE>  вкл/выкл сохранения состояния в локальном хранилище. Последнее состояние сохраняется в файл в папке приложения, и используется при следующем запуске. Есть возможность реализовать произвольный загрузчик. Значение по умолчанию: <CODE>true</CODE>

### Добавление выключателей
На странице Feature Flags, можно добавить необходимые выключатели. В Gitlab необходимо использовать названия в snake case, например: <CODE>enable_one_feature</CODE>. Рекомендуется использовать "позитивный" нейминг и продумать необходимое интуитивно понятное значение по умолчанию.

Для каждого флага необходимо указать список <CODE>Environment</CODE> для которых он актуален. Для отсутствующей в списке среды будет использоваться значение по умолчанию. Это позволяет постепенно подключать функции от dev к prod. 

Далее есть возможность добавить стратегию активации (постепенного включения функции) на основе данных из контекста (<CODE>UserID/SessionID/etc</CODE>)

### Активация сервиса отслеживания состояния выключателей

Добавьте в файл <CODE>Startup.cs</CODE>

```csharp
services.ConfigureFeatureToggle<Startup>(this.Configuration);
```

### Использование выключателей в коде

- Через автоматическую привязку. Добавьте атрибут <CODE>[FeatureToggles]</CODE> к произвольному классу. Экземпляр данного класса будет автоматически зарегистрирован в DI а значения полей будут обновляться в случае изменения настроек на странице проекта. 
  
  Соответствие настроек и полей класса определяется:
  - с помощью атрибута <CODE>[FeatureToggle(name, defaultvalue)]</CODE> 
  - по совпадению имени настройки и имени свойства (без учета "_" и регистра) 
```csharp
[FeatureToggles]
public class SomeToggles
{
    public bool EnableOneFeature { get; set; }

    [FeatureToggle("enable_one_feature", defaultValue: true)]
    public bool AnotherName { get; set; }

}

...
    
public class SomeLogic
{
    public SomeLogic(SomeToggles someToggles)
    {
        var isEnabled = someToggles.EnableOneFeature;            
    }
}
```
- Явно через вызов метода <CODE>IFeatureToggleService.IsEnabled(string name)</CODE>

```csharp
var isEnabled = featureToggleService.IsEnabled("enable_one_feature");

var isEnabled = featureToggleService.IsEnabled(
    "enable_one_feature", 
    new Dictionary<string, string> { { "userId", "SOME_ID" } });
```

- Есть возможность реализовать специфический провайдер контекста.


## Постепенное включение функции для части пользователей

В случаях когда необходимо постепенно активировать новую функцию для части пользователей можно воспользоваться одной из стратегий активации:

- <CODE>Percent rollout</CODE> Активация для заданной части пользователей. В этом режиме на сервере с FeatureToggle указывается желаемый процент проникновения функции и данные на основе которых будет определяться уникальность запроса <CODE>UserID/SessionID/etс</CODE>. Настройки активации обновляются один раз, после чего для каждого вызова, на основе, например, <CODE>UserID</CODE> и хеш функции определяется попал ли данный пользователь в группу для которых функция включена. Пример <CODE>Samples/SampleFeatureToggeling</CODE>  
- <CODE>UserIDs</CODE> В этом режиме специфицируется список пользователей, для которых данная функция доступна. Данный список передается один раз и используется при проверках выключателей через <CODE>IsEnabled()</CODE> 

## Производительность и нагрузка на сервис FeatureToggle

При правильном использовании подхода, в одном приложении недолжно быть нескольких клиентов FeatureToggle (за некоторыми исключениями).

Клиент заботится о том, что-бы получать актуальное состояние оптимальным образом. Запросы на наличие обновлений происходят с заданным периодом.
Полное считывание данных происходит только при наличии изменений. 

Вычисление значений для каждого конкретного случая происходит без запросов на внешний сервис. Значения, перечень всех флагов и настройки функций активации кэшируются.  

## Контроль доступа за настройками

Обычно доступ пользователя к коду приложения (Gitlab) говорит о том, что у него достаточная квалификация он понимает как работает приложение и ему разрешено изменять FeatureToggle.

Для случаев когда нужно ограничить круг лиц с правом управлять релизом, возможно использовать отдельный проект (Gitlab) и управлять выключателями в нем.

Для реализации сложной ролевой модели доступа к разным проектам возможно использовать отдельный сервис с FeatureToggle.
